"0","#### GAGESii_TS data"
"0",""
"0","# Read in table with time series years of interest, and the related years for"
"0","# each time series variable of interest using only surrounding years of the "
"0","# actual year available"
"0","# keep only the years are represented across all variables"
"0","dt_years_ts_srndgyrs <- as.data.table(openxlsx::read.xlsx("
"0","  ""D:/Projects/GAGESii_ANNstuff/DataNotes.xlsx"","
"0","  sheet = ""GAGESii_TS_Overlap_SrndgYrs""))["
"0","    , ':=' (LandUSENWALT_xxxx = NULL,"
"0","             DamRemovals = NULL,"
"0","            # ForestCanopy = NULL,"
"0","             LandUseNLCD_xxxx = NULL,"
"0","             # ImpervNLCD = NULL,"
"0","             Timber = NULL)"
"0","  ]"
"0",""
"0",""
"0","dt_years_ts_srndgyrs <- as.data.table("
"0","  dt_years_ts_srndgyrs["
"0","    apply("
"0","      dt_years_ts_srndgyrs, 1, function(x){"
"0","        !any(is.na(x))"
"0","        }"
"0","      ),"
"0","    ]"
"0",")"
"0"," "
"0",""
"0",""
"0","# convert to characters"
"0","dt_years_ts_srndgyrs <- as.data.table("
"0","  apply("
"0","    dt_years_ts_srndgyrs, 2, as.character"
"0","    )"
"0","  )"
"0",""
"0","# rename columns                                          "
"0","colnames(dt_years_ts_srndgyrs) <- c(""year"","
"0","                                    ""ag"","
"0","                                    ""NWALT"","
"0","                                    ""Housing"","
"0","                                    ""Population"","
"0","                                    ""WaterUse"","
"0","                                    ""ForestCanopy"","
"0","                                    ""NLCD"")"
"0",""
"0",""
"0",""
"0",""
"0","# convert to long format"
"0","dt_years_ts_srndgyrs <- data.table::melt("
"0","  dt_years_ts_srndgyrs,"
"0","  id.vars = ""year"","
"0","  value.name = ""year_av"","
"0","  measure.vars = colnames(dt_years_ts_srndgyrs)[2:8]"
"0",")"
"0",""
"0","# Read in table with time series years of interest, and the related years for"
"0","# each time series variable of interest using only the nearest years"
"0","dt_years_ts_nrstyr <- as.data.table(openxlsx::read.xlsx("
"0","  ""D:/Projects/GAGESii_ANNstuff/DataNotes.xlsx"","
"0","  sheet = ""GAGESii_TS_Overlap_NrstYr""))["
"0","    , ':=' (LandUSENWALT_xxxx = NULL,"
"0","             DamRemovals = NULL,"
"0","             # ForestCanopy = NULL,"
"0","             # LandUseNLCD_xxxx = NULL,"
"0","             ImpervNLCD = NULL,"
"0","             Timber = NULL)"
"0","  ]"
"0","    "
"0","# Convert to characters"
"0","dt_years_ts_nrstyr <- as.data.table("
"0","  apply("
"0","    dt_years_ts_nrstyr, 2, as.character"
"0","    )"
"0",")"
"0",""
"0","# rename columns                             "
"0","colnames(dt_years_ts_nrstyr) <- c(""year"","
"0","                                    ""ag"","
"0","                                    ""NWALT"","
"0","                                    ""Housing"","
"0","                                    ""Population"","
"0","                                    ""WaterUse"", "
"0","                                    ""ForestCanopy"","
"0","                                    ""NLCD"")"
"0",""
"0","# convert to long format"
"0","dt_years_ts_nrstyr <- data.table::melt("
"0","  dt_years_ts_nrstyr,"
"0","  id.vars = ""year"","
"0","  value.name = ""year_av"","
"0","  measure.vars = colnames(dt_years_ts_nrstyr)[2:8]"
"0",")"
"0",""
"0","# same but for time series xlsx sheet"
"0","# further filter land use tabs to the years of interest"
"0","tabnames.ts <- openxlsx::getSheetNames("
"0","  ""D:/DataWorking/GAGESii_TS/All_GAGESiiTS.xlsx"""
"0",")"
"0","tabnames.ts <- tabnames.ts["
"0","  !tabnames.ts %in% c("
"0","    # ""ForestCanopy"","
"0","    # ""ImpervNLCD"","
"0","    # ""LandUseNLCD_2001"","
"0","    # ""LandUseNLCD_2006"","
"0","    # ""LandUseNLCD_2011"","
"0","    ""LandUseNLCD_Codes"","
"0","    ""LandUseNWALT_1974"","
"0","    #""LandUseNWALT_1982"","
"0","    #""LandUseNWALT_1992"","
"0","    #""LandUseNWALT_2002"","
"0","    #""LandUseNWALT_2012"","
"0","    ""LandUseNWALT_82_12"","
"0","    ""LandUseNWALT_Codes"","
"0","    ""N_P_Fertilizer"","
"0","    ""N_P_Manure"","
"0","    ""PeakFlow_Codes_Anthrop"","
"0","    ""Timber"""
"0","    "
"0","    )"
"0","  ]"
"0",""
"0","# Loop through time series tabnames and read in tabs of GAGESii_ts variables."
"0","# Filter to the specific variables of listed in tmp_voi_ts  "
"0","# Remove duplicated stations and filter to stations w/continues of years"
"0","# to assign each dt to the global env. uncomment the appropriate lines"
"0",""
"0","# go parallel"
"0","#cl <- parallel::makeCluster(cl)"
"0","# parallel::clusterExport(cl, ""dt_contflow"")"
"0","# parallel::clusterApply(cl, library(data.table))"
"0",""
"0",""
"0","dt_expl_ts <- Reduce("
"0","  function(x, y) {"
"0","      merge(x, y, by = ""STAID"", all = TRUE)"
"0","    }, # close function(x, y)"
"0","      lapply("
"0","        tabnames.ts, function(z) {"
"0","          # assign(paste0(""dt_"", z),"
"0","                 data.table::as.data.table("
"0","                  openxlsx::read.xlsx("
"0","                  ""D:/DataWorking/GAGESii_TS/All_GAGESiiTS.xlsx"","
"0","                  sheet = z) # close read.xlsx"
"0","                  )#[ # close as.data.table"
"0","                  # !duplicated(STAID)"
"0","                  # ]["
"0","                  #   STAID %chin% dt_contflow$STAID"
"0","                  # ]"
"0","          #, envir = .GlobalEnv) # close assign"
"0","          } # close function(z)"
"0","        ) # close lapply"
"0","      #} # function(x, y)"
"0","    )[ # close Reduce"
"0","   !duplicated(STAID) # remove duplicated stations"
"0","    ]["
"0","      STAID %chin% dt_contflow$STAID # keep stations w/>=4yrs cont. flow"
"0","    ]"
"0",""
"0",""
"0","# Read in names of specific vars to be used from GAGESii_ts"
"0","tmp_voi_ts <- unlist("
"0","  openxlsx::read.xlsx("
"0","          ""D:/Projects/GAGESii_ANNstuff/DataNotes.xlsx"","
"0","          sheet = ""GAGESii_TS_list"","
"0","          colNames = FALSE)"
"0",")"
"0",""
"0",""
"0","# define vector of colnames to subset by"
"0","tmp_sbst <- colnames(dt_expl_ts) %in% tmp_voi_ts"
"0","# subset dt_expl_ts "
"0","dt_expl_ts <- dt_expl_ts["
"0","  , ..tmp_sbst"
"0","  ]"
"0",""
"0",""
"0","# patterns to match in dt_expl_ts to convert to wide format"
"0","tmp_patterns <- c(""NLCD"","
"0","                  ""NWALT"","
"0","                  ""imperv"","
"0","                  ""hcrop"","
"0","                  ""irrig"","
"0","                  ""wu"","
"0","                  ""PDEN"","
"0","                  ""HDEN"")"
"0",""
"0","dt_expl_ts_long <- data.table::rbindlist("
"0","  lapply("
"0","  tmp_patterns, function(x) {"
"0","    if(x == ""NWALT"") {"
"0","      data.table::melt("
"0","      dt_expl_ts,"
"0","      id.vars = ""STAID"","
"0","      measure.vars = patterns(x),"
"0","      variable.factor = FALSE"
"0","    )[ # close melt"
"0","      , ':=' (year = substr(variable, 6, 7),"
"0","              VOI = substr(variable, 9, nchar(as.vector(variable))),"
"0","              variable = x"
"0","              )"
"0","    ][ # replace two digit years with four digit years"
"0","      year %chin% c(""82"", ""92""), year := paste0(""19"", year)"
"0","    ]["
"0","      year %chin% c("",02"", ""12""), year := paste0(""20"", year)"
"0","    ]"
"0","      } else if(x == ""NLCD"") {"
"0","      data.table::melt("
"0","      dt_expl_ts,"
"0","      id.vars = ""STAID"","
"0","      measure.vars = patterns(x),"
"0","      variable.factor = FALSE"
"0","    )[ # close melt"
"0","      , ':=' (year = substr(variable, 5, 6),"
"0","              VOI = substr(variable, 8, nchar(as.vector(variable))),"
"0","              variable = x"
"0","              )"
"0","    ]["
"0","      year %chin% c(""01"", ""06"", ""11""), year := paste0(""20"", year)"
"0","    ]"
"0","      } else if(x == ""hcrop"" | x == ""irrig"") { # close if"
"0","      data.table::melt("
"0","      dt_expl_ts,"
"0","      id.vars = ""STAID"","
"0","      measure.vars = patterns(x),"
"0","      variable.factor = FALSE"
"0","     )[ # close melt"
"0","       , ':=' (year = substr(variable, 6, 9), "
"0","               VOI = x,"
"0","               variable = ""ag"""
"0","               )"
"0","       ]"
"0","      } else if (x == ""imperv"") {# close else if"
"0","      data.table::melt("
"0","      dt_expl_ts,"
"0","      id.vars = ""STAID"","
"0","      measure.vars = patterns(x),"
"0","      variable.factor = FALSE"
"0","     )[ # close melt"
"0","       , ':=' (year = substr(variable, 7, 10), "
"0","               VOI = x,"
"0","               variable = ifelse(nchar(as.vector(variable)) > 10, ""NWALT"", ""NLCD"")"
"0","               )"
"0","       ]"
"0","        } else if (x == ""wu"") { # close else if"
"0","        data.table::melt("
"0","      dt_expl_ts,"
"0","      id.vars = ""STAID"","
"0","      measure.vars = patterns(x),"
"0","      variable.factor = FALSE"
"0","     )[ # close melt"
"0","       , ':=' (year = substr(variable, 3, 6), "
"0","               VOI = x,"
"0","               variable = ""WaterUse"""
"0","               )"
"0","       ]"
"0","          } else if (x == ""HDEN"") {# close else if"
"0","          data.table::melt("
"0","      dt_expl_ts,"
"0","      id.vars = ""STAID"","
"0","      measure.vars = patterns(x),"
"0","      variable.factor = FALSE"
"0","     )[ # close melt"
"0","       , ':=' (year = substr(variable, 6, 9), "
"0","               VOI = x,"
"0","               variable = ""Housing"""
"0","               )"
"0","       ]"
"0","          } else if (x == ""PDEN"") {# close else if"
"0","          data.table::melt("
"0","      dt_expl_ts,"
"0","      id.vars = ""STAID"","
"0","      measure.vars = patterns(x),"
"0","      variable.factor = FALSE"
"0","     )[ # close melt"
"0","       , ':=' (year = substr(variable, 6, 9), "
"0","               VOI = x,"
"0","               variable = ""Population"""
"0","               )"
"0","       ]"
"0","          }# close else if"
"0","      } # close function"
"0","  ) # close lapply"
"0",")# %>%  # close rbindlist"
"0","# rbind(data.table( # bind damremoval"
"0","#       ""STAID"" = dt_expl_ts$STAID,"
"0","#       ""variable"" = ""DamRemoval"","
"0","#       ""value"" = dt_expl_ts$YearDamRemoved,"
"0","#       ""year"" = dt_expl_ts$YearDamRemoved,"
"0","#       ""VOI"" = ""YearRemoved"""
"0","#       ) # close data.table"
"0","#     ) # close rbind"
"0",""
"0",""
"0",""
"0","#### GAGESii (static) data"
"0",""
"0","# Return tab names from the gagesII_sept30_2011_conterm.xlsx file"
"0","tabnames.stat <- openxlsx::getSheetNames("
"0","  ""D:/DataWorking/GAGESii/basinchar_and_report_sept_2011/gagesII_sept30_2011_conterm.xlsx"""
"0",")"
"0",""
"0","tabnames.stat <- tabnames.stat["
"0","  !tabnames.stat %in% c("
"0","    ""Bound_QA"","
"0","    ""FlowRec"","
"0","    ""LC06_Basin"","
"0","    ""LC06_Mains100"","
"0","    ""LC06_Mains800"","
"0","    ""LC06_Rip100"","
"0","    ""LC06_Rip800"","
"0","    ""LC_Crops"","
"0","    ""Nutrient_App"","
"0","    ""Pest_App"","
"0","    ""Pop_Infrastr"","
"0","    ""Prot_Areas"","
"0","    ""Regions"","
"0","    ""X_Region_Names"""
"0","    )"
"0","  ]"
"0",""
"0","# Loop through tstatic tabnames and read in tabs of GAGESii variables."
"0","# Filter to the specific variables of listed in tmp.voi  "
"0","# Commented lines related to assign, can be uncommented if you would like"
"0","# each tab to be saved to its own data.table in the the global env."
"0",""
"0","dt_expl_stat <- Reduce("
"0","  merge, "
"0","    lapply("
"0","    tabnames.stat, function(x) {"
"0","      #assign("
"0","        #paste0(""dt_"", x), "
"0","      as.data.table("
"0","          openxlsx::read.xlsx("
"0","          ""D:/DataWorking/GAGESii/basinchar_and_report_sept_2011/gagesII_sept30_2011_conterm.xlsx"","
"0","          sheet = x) # close read.xlsx"
"0","        )#, # close as.data.table"
"0","     #) # close assign     envir = .GlobalEnv) # close assign"
"0","    } # close function"
"0","  ) # close lapply"
"0",")[ # close Reduce"
"0","   !duplicated(STAID) # remove duplicated stations"
"0","    ]["
"0","      STAID %in% dt_contflow$STAID # keep stations w/>=4yrs cont. flow"
"0","    ]"
"0",""
"0",""
"0","#### NOTE:"
"0","# STAID 06900050 is missing a value for HGVAR. Replacing with a 0, since the "
"0","# other soil percentages add to 100% already."
"0","dt_expl_stat[STAID == ""06900050"", HGVAR := 0]"
"0",""
"0","# Read in names of specific vars to be used from GAGESii_ts"
"0","tmp_voi_stat<- unlist("
"0","  openxlsx::read.xlsx("
"0","          ""D:/Projects/GAGESii_ANNstuff/DataNotes.xlsx"","
"0","          sheet = ""GAGESii_Static_list"","
"0","          colNames = FALSE)"
"0",")"
"0",""
"0","# define vector of colnames to subset by"
"0","tmp_sbst <- (colnames(dt_expl_stat) %in% tmp_voi_stat)"
"0","# subset dt_expl_ts "
"0","dt_expl_stat <- dt_expl_stat["
"0","  , ..tmp_sbst"
"0","  ]"
"0",""
"0","# # write filtered static vars to a csv"
"0","# fwrite(dt_expl_stat,"
"0","#        file = ""D:/Projects/GAGESii_ANNstuff/Data_Out/GAGES_Static_Filtered.csv"")"
"0",""
"0",""
"0","rm(list = ls(pattern = ""tmp_""))"

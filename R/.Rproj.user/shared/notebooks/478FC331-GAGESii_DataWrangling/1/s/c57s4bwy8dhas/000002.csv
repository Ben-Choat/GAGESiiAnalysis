"0","# Calculate variability metrics (excluding dams)"
"0","tmp_ts_change <- dt_expl_ts_long[!variable == ""DamRemoval"""
"0","  , .(""StDev"" = round(sd(value, na.rm = TRUE), 3),"
"0","      ""Range"" = max(value, na.rm = TRUE) - min(value, na.rm = TRUE),"
"0","      ""Prcnt_Change"" = 100*(value[length(value)] - (value[1]) + 1e-11)/(value[1] + 1e-11) "
"0","    ), # close '.' list"
"0","  by = .(STAID, variable, VOI)]["
"0","    Range == -Inf, Range := NA # replace -Inf with NA"
"0","  ]"
"0",""
"0","# summarise change by voi"
"0","tmp_ts_chgsum <- "
"0","  tmp_ts_change[,"
"0","               .(StDev_Qnt05 = quantile(StDev, 0.05, na.rm = TRUE),"
"0","                 StDev_Qnt25 = quantile(StDev, 0.25, na.rm = TRUE),"
"0","                 StDev_Qnt50 = quantile(StDev, 0.50, na.rm = TRUE),"
"0","                 StDev_Qnt75 = quantile(StDev, 0.75, na.rm = TRUE),"
"0","                 StDev_Qnt90 = quantile(StDev, 0.90, na.rm = TRUE),"
"0","                 StDev_Qnt95 = quantile(StDev, 0.95, na.rm = TRUE),"
"0","                 StDev_Qnt99 = quantile(StDev, 0.99, na.rm = TRUE),"
"0","                 Rng_Qnt05 = quantile(Range, 0.05, na.rm = TRUE),"
"0","                 Rng_Qnt25 = quantile(Range, 0.25, na.rm = TRUE),"
"0","                 Rng_Qnt50 = quantile(Range, 0.50, na.rm = TRUE),"
"0","                 Rng_Qnt75 = quantile(Range, 0.75, na.rm = TRUE),"
"0","                 Rng_Qnt90 = quantile(Range, 0.90, na.rm = TRUE),"
"0","                 Rng_Qnt95 = quantile(Range, 0.95, na.rm = TRUE),"
"0","                 Rng_Qnt99 = quantile(Range, 0.99, na.rm = TRUE),"
"0","                 PrcChng_Qnt25 = quantile(Prcnt_Change, 0.25, na.rm = TRUE),"
"0","                 PrcChng_Qnt50 = quantile(Prcnt_Change, 0.50, na.rm = TRUE),"
"0","                 PrcChng_Qnt75 = quantile(Prcnt_Change, 0.75, na.rm = TRUE),"
"0","                 PrcChng_Qnt90 = quantile(Prcnt_Change, 0.90, na.rm = TRUE),"
"0","                 PrcChng_Qnt95 = quantile(Prcnt_Change, 0.95, na.rm = TRUE),"
"0","                 PrcChng_Qnt99 = quantile(Prcnt_Change, 0.99, na.rm = TRUE)"
"0","                 ),"
"0","               by = VOI]"
"0",""
"0","################# Begin filtering by quantile"
"0","# to switch which quantile is used, just highlight this bit of code then search"
"0","# and replace the current quantile with the one you want"
"0","# e.g., replace 90 with 95"
"0",""
"0","# get STAIDs with those experiencing > the 90th quantile removed"
"0",""
"0","dt_expl_tsf90 <- as.data.table(merge("
"0","  dt_expl_ts_long, tmp_ts_change, by = c(""STAID"", ""variable"", ""VOI"")#, all.x = TRUE"
"0",") %>%  # close merge"
"0","  merge("
"0","    ., tmp_ts_chgsum[, .(VOI, StDev_Qnt90, Rng_Qnt90, PrcChng_Qnt90)], by = ""VOI"""
"0","    ) # close merge"
"0",")[ # close as.data.table"
"0","      StDev <= StDev_Qnt90 & "
"0","        Range <= Rng_Qnt90 & "
"0","        Prcnt_Change <= PrcChng_Qnt90 #|"
"0","        # is.na(value),"
"0","    ] %>% "
"0","   merge("
"0","     ., dt_basin_classif[,.(STAID, CLASS)], "
"0","  by = ""STAID"""
"0","   ) # close merge"
"0",""
"0",""
"0","# Find limiting VOI (voi with least number of stations) after filtering, "
"0","# and filter the rest of the VOI to align with those stations"
"0","tmp_lngth <- dt_expl_tsf90[, length(unique(STAID)), by = VOI]"
"0","tmp_voi_min <- tmp_lngth[which(V1 == min(V1))]$VOI"
"0",""
"0","# Define data.table filtered to quantile of choice (see above) and using the"
"0","# VOI with the fewest values to filter STAIDs"
"0","dt_expl_tsf90min <- #merge("
"0","  dt_expl_tsf90["
"0","  STAID %in% dt_expl_tsf90[VOI == tmp_voi_min, STAID]"
"0","  ]"
"0",""
"0","# return number of reference and non-reference gages after filtering based on speficied quantile."
"0","ref_fq90 <- length(dt_expl_tsf90min[CLASS == ""Ref"", unique(STAID)])"
"0","nonref_fq90 <- length(dt_expl_tsf90min[CLASS == ""Non-ref"", unique(STAID)])"
"0","# return total number of gages after filtering"
"0","tot_fq90 <- length(dt_expl_tsf90min[, unique(STAID)])"
"0",""
"0",""
"0","cat(""Reference stations removed after filtering to those with >= 4 consecutive years: \n"", "
"0","    ref_init - ref_cntyrs, "
"0","    ""\nNon-reference stations removed after filtering to those with >= 4 consecutive years: \n"", "
"0","    nonref_init - nonref_cntyrs,"
"0","    ""\nFurthure reference stations removed after filtering the specified quantile: \n"", "
"0","    ref_cntyrs - ref_fq90, "
"0","    ""\nFurthure non-reference stations removed after filtering the specified quantile: \n"", "
"0","    nonref_cntyrs - nonref_fq90,"
"0","    ""\nLeaving the total reference stations at: \n"","
"0","    ref_fq90,"
"0","    ""\nand the total non-refernence stations at: \n"","
"0","    nonref_fq90,"
"0","    ""\nFor a total of: \n"","
"0","    ref_fq90 + nonref_fq90, ""stations"""
"0","    )"
"1","Reference stations removed after filtering to those with >= 4 consecutive years: 
"
"1"," "
"1","483"
"1"," "
"1","
Non-reference stations removed after filtering to those with >= 4 consecutive years: 
"
"1"," "
"1","1682"
"1"," "
"1","
Furthure reference stations removed after filtering the specified quantile: 
"
"1"," "
"1","249"
"1"," "
"1","
Furthure non-reference stations removed after filtering the specified quantile: 
"
"1"," "
"1","1159"
"1"," "
"1","
Leaving the total reference stations at: 
"
"1"," "
"1","1215"
"1"," "
"1","
and the total non-refernence stations at: 
"
"1"," "
"1","4279"
"1"," "
"1","
For a total of: 
"
"1"," "
"1","5494"
"1"," "
"1","stations"
"0","################## End filtering based on quantile"
"0",""
"0",""
"0",""
"0",""
"0","rm(list=ls(pattern = ""tmp""))"
"0","rm(dt_expl_tsf90)"
"0",""
"0","# "
"0","# # plot "
"0","# p <- ggplot2::ggplot(data = na.omit(dt_expl_ts_long[variable == ""NWALT""])) +"
"0","#   geom_histogram(aes(y = value)) +"
"0","#   facet_grid(rows = vars(VOI), scales = ""free"")# +"
"0","#   #lims(y = c(0, 1))"
"0","# "
"0","# plotly::ggplotly(p)"
"0",""
